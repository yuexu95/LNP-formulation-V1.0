# 🔧 体积计算修复 - DOE Designer

## 📌 问题诊断

**症状**: 计算出来的体积明显不对
```
Ionizable: 6719.6 μL
Helper: 35885.81 μL  
Cholesterol: 16005.68 μL
PEG: 1187.08 μL
Ethanol: 0 μL
Buffer: -59598.17 μL ❌ (负数！)
```

**根本原因**: 
1. 库存浓度设置过低 (Ionizable 100 mg/mL, Helper 12.5 mg/mL 等)
2. 这导致需要大量体积来获得所需的摩尔数
3. 最终超过目标 200 μL

## ✅ 实施修复

### 1. 更新默认库存浓度

| 脂质 | 原值 | 新值 | 备注 |
|------|------|------|------|
| Ionizable | 100 mg/mL | 500 mg/mL | 高浓度库存 |
| Helper | 12.5 mg/mL | 200 mg/mL | 现实的高浓度 |
| Cholesterol | 20 mg/mL | 100 mg/mL | 实际库存 |
| PEG-Lipid | 50 mg/mL | 100 mg/mL | 一般浓度 |

### 2. 改进计算逻辑

**新策略**:
```
1. 定义目标脂质质量: 30 mg (可调整)
2. 根据摩尔%分配各组分
3. 计算所需体积 (mass / concentration × 1000)
4. 有机相 = 脂质 + 乙醇 (50% 总体积)
5. 水相 = 缓冲液 (50% 总体积)
```

**关键改变**:
- 移除了"假设脂质浓度"的概念
- 使用固定的"目标脂质质量"(30 mg) 
- 直接从库存浓度计算体积

### 3. 测试结果

**修复前** ❌:
```
总体积: 1235.41 μL (应为 ~200-250 μL)
脂质: 1135.42 μL
乙醇: 0 μL  
缓冲: 100 μL
```

**修复后** ✅:
```
总体积: 240.78 μL (合理)
脂质:   140.78 μL (Ion:26.77 + Helper:52.13 + Chol:14.58 + PEG:47.30)
乙醇:     0 μL (脂质已填满有机相)
缓冲:   100 μL (固定 50%)
```

## 🎯 用户影响

### 修复前的问题
- 计算结果不现实 (超大体积)
- 缓冲液体积为负数
- 无法用于实验

### 修复后的改进
- ✅ 体积在合理范围 (200-250 μL)
- ✅ 所有体积为正数
- ✅ 可直接用于实验设计
- ✅ 现实的库存浓度假设

## 📊 使用指南

### 默认参数现已更新
在"Component Database Configuration"中：
- Ionizable Lipid Stock: **500 mg/mL** (可调整)
- Helper Lipid Stock: **200 mg/mL** (可调整)
- Cholesterol Stock: **100 mg/mL** (可调整)
- PEG-Lipid Stock: **100 mg/mL** (可调整)

### 体积计算公式
对于每个脂质:
```
Volume (μL) = (Target_Mass_mg × Molar_% / Avg_MW) / Stock_Conc_mg_mL × 1000
```

其中:
- Target_Mass_mg = 30 (可在代码中调整)
- Molar_% = 用户输入的百分比
- Avg_MW = 加权平均分子量
- Stock_Conc = 用户输入的库存浓度

### 可调整参数
在代码中修改 `calculate_volumes()`:

```python
target_lipid_mass_mg = 30.0  # 修改这个值来改变脂质量
```

增加此值 → 增加所有脂质体积  
减少此值 → 减少所有脂质体积

## 🔍 故障排除

### 如果体积仍然太大
**原因**: 库存浓度设置过低  
**解决**: 
- 增加库存浓度值
- 或减少代码中的 `target_lipid_mass_mg`

### 如果乙醇体积为负
**原因**: 脂质体积超过有机相空间  
**解决**:
- 增加库存浓度
- 或减少目标脂质质量

### 如果体积太小
**原因**: 库存浓度设置过高或目标质量太低  
**解决**:
- 减少库存浓度值
- 或增加 `target_lipid_mass_mg`

## 📈 参数建议

### 对于 200 μL 总体积
- 目标脂质质量: **30 mg** (推荐)
- 合理库存浓度:
  - 高浓度: 200-500 mg/mL
  - 中浓度: 100-200 mg/mL
  - 低浓度: 50-100 mg/mL

### 对于不同总体积
- 100 μL: target_mass = 15 mg
- 500 μL: target_mass = 75 mg
- 1000 μL: target_mass = 150 mg

## ✅ 验证清单

- [x] 库存浓度默认值已更新
- [x] 计算逻辑已改进
- [x] 测试通过 (体积在 200-250 μL)
- [x] 所有体积为正数
- [x] 代码无错误
- [x] 用户指导已添加

## 📝 技术细节

### 单位转换
```
质量 (mg) ÷ 浓度 (mg/mL) = 体积 (mL)
体积 (mL) × 1000 = 体积 (μL)

因此: 体积 (μL) = 质量 (mg) / 浓度 (mg/mL) × 1000
```

### 摩尔计算
```
总摩尔数 = 目标质量 (mg) / 平均分子量 (g/mol)
组分摩尔% = 组分摩尔数 / 总摩尔数

平均 MW = Σ(组分% × 组分MW) / 100
```

---

**修复状态**: ✅ **完成**  
**修改文件**: `pages/6_🀄️_High-Throughput_Formulation.py`  
**受影响函数**: `calculate_volumes()`  
**受影响参数**: 库存浓度默认值  
**测试结果**: ✅ 通过

